name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint HTML, CSS, and JavaScript
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install linters
      run: |
        npm install -g htmlhint stylelint eslint
        npm install -g stylelint-config-standard
    
    - name: Lint HTML
      run: |
        htmlhint "*.html" || echo "HTMLHint issues found (non-blocking)"
      continue-on-error: true
    
    - name: Lint CSS
      run: |
        npx stylelint "*.css" --config-basedir . || echo "Stylelint issues found (non-blocking)"
      continue-on-error: true
    
    - name: Lint JavaScript
      run: |
        npx eslint "*.js" --no-eslintrc --env browser --env es6 || echo "ESLint issues found (non-blocking)"
      continue-on-error: true

  validate:
    name: Validate Files
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for required files
      run: |
        echo "Checking for required files..."
        [ -f "index.html" ] && echo "✓ index.html exists" || (echo "✗ index.html missing" && exit 1)
        [ -f "fotovideo.html" ] && echo "✓ fotovideo.html exists" || (echo "✗ fotovideo.html missing" && exit 1)
        [ -f "script.js" ] && echo "✓ script.js exists" || (echo "✗ script.js missing" && exit 1)
        [ -f "style.css" ] && echo "✓ style.css exists" || (echo "✗ style.css missing" && exit 1)
        [ -f "sitemap.xml" ] && echo "✓ sitemap.xml exists" || echo "⚠ sitemap.xml missing"
        [ -f "robots.txt" ] && echo "✓ robots.txt exists" || echo "⚠ robots.txt missing"
        [ -f "README.md" ] && echo "✓ README.md exists" || echo "⚠ README.md missing"
        [ -f "LICENSE" ] && echo "✓ LICENSE exists" || echo "⚠ LICENSE missing"
    
    - name: Check for sensitive data
      run: |
        echo "Checking for potential sensitive data..."
        if grep -r "G-[A-Z0-9]\{10\}" *.html *.js 2>/dev/null | grep -v "G-XXXXXXXXXX"; then
          echo "⚠ Warning: Potential Google Analytics ID found. Use placeholder or secrets."
        else
          echo "✓ No Google Analytics ID detected in code"
        fi
        
        if grep -ri "password\|secret\|api[_-]key" *.html *.js *.css 2>/dev/null | grep -v "placeholder"; then
          echo "⚠ Warning: Potential sensitive data found"
        else
          echo "✓ No obvious sensitive data detected"
        fi
    
    - name: Validate XML files
      run: |
        if [ -f "sitemap.xml" ]; then
          xmllint --noout sitemap.xml && echo "✓ sitemap.xml is valid XML" || echo "✗ sitemap.xml has XML errors"
        fi

  # Deployment job (commented out - enable after approval)
  # deploy:
  #   name: Deploy to GitHub Pages
  #   runs-on: ubuntu-latest
  #   needs: [lint, validate]
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #   
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #   
  #   - name: Setup Node.js
  #     uses: actions/setup-node@v4
  #     with:
  #       node-version: '20'
  #   
  #   - name: Inject Google Analytics ID (if using secrets)
  #     if: ${{ secrets.GA_MEASUREMENT_ID != '' }}
  #     run: |
  #       sed -i "s/gaId: ''/gaId: '${{ secrets.GA_MEASUREMENT_ID }}'/" index.html
  #       sed -i "s/gaId: ''/gaId: '${{ secrets.GA_MEASUREMENT_ID }}'/" fotovideo.html
  #   
  #   - name: Deploy to GitHub Pages
  #     uses: peaceiris/actions-gh-pages@v3
  #     with:
  #       github_token: ${{ secrets.GITHUB_TOKEN }}
  #       publish_dir: ./
  #       cname: mechanik-plus.com

  accessibility:
    name: Accessibility Check (Manual)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for accessibility attributes
      run: |
        echo "Checking for basic accessibility attributes..."
        
        # Check for alt attributes on images
        if grep -r "<img" *.html | grep -v "alt="; then
          echo "⚠ Warning: Some images may be missing alt attributes"
        else
          echo "✓ All img tags appear to have alt attributes"
        fi
        
        # Check for language attribute
        if grep -r "<html" *.html | grep "lang="; then
          echo "✓ HTML lang attribute found"
        else
          echo "⚠ Warning: HTML lang attribute may be missing"
        fi
        
        # Check for viewport meta tag
        if grep -r "viewport" *.html; then
          echo "✓ Viewport meta tag found"
        else
          echo "⚠ Warning: Viewport meta tag may be missing"
        fi
        
        # Check for skip links
        if grep -r "skip-to-content" *.html; then
          echo "✓ Skip-to-content link found"
        else
          echo "⚠ Warning: Skip-to-content link may be missing"
        fi

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, validate, accessibility]
    if: always()
    
    steps:
    - name: Check workflow status
      run: |
        echo "CI Pipeline completed"
        echo "Review the individual job results above for details"
